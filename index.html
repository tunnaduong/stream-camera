<!DOCTYPE html>
<html>
<head>
  <title>WebRTC 2-Way Call</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #000; color: #fff; }
    video { width: 45%; max-width: 640px; border: 2px solid white; margin: 1rem; }
    #btns { margin-top: 1rem; }
  </style>
</head>
<body>
  <h2>WebRTC Gá»i Video Hai Chiá»u</h2>
  <div id="btns">
    <button onclick="startSender()">ğŸ“± Gá»­i tá»« iPhone</button>
    <button onclick="startReceiver()">ğŸ–¥ Nháº­n trÃªn mÃ¡y tÃ­nh</button>
    <button onclick="startTwoWayCall()">ğŸ“ Gá»i 2 chiá»u</button>
  </div>

  <div>
    <video id="localVideo" autoplay playsinline muted></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // ğŸ” DÃ¡n config Firebase cá»§a báº¡n táº¡i Ä‘Ã¢y
    const firebaseConfig = {
        apiKey: "AIzaSyCXq2XuAoR_Z0Cx4ZGzqoYQ56qbBZN4wxM",
        authDomain: "stream-camera-27465.firebaseapp.com",
        databaseURL: "https://stream-camera-27465-default-rtdb.firebaseio.com",
        projectId: "stream-camera-27465",
        storageBucket: "stream-camera-27465.firebasestorage.app",
        messagingSenderId: "317939678008",
        appId: "1:317939678008:web:1b628b1fc43822130bdfcd",
        measurementId: "G-ENKM03MX2Q",
      };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const pc = new RTCPeerConnection({
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });

    let localStream = null;
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    async function setupLocalStream(audio = false) {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio });
      localVideo.srcObject = localStream;
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    }

    async function startSender() {
      await setupLocalStream(false); // chá»‰ video
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      db.ref("webrtc/offer").set(JSON.stringify(offer));
      pc.onicecandidate = e => {
        if (e.candidate) db.ref("webrtc/sender_candidate").push(JSON.stringify(e.candidate));
      };
    }

    async function startReceiver() {
      pc.ontrack = (event) => remoteVideo.srcObject = event.streams[0];
      const offerSnap = await db.ref("webrtc/offer").once("value");
      if (!offerSnap.exists()) return alert("ChÆ°a cÃ³ tÃ­n hiá»‡u gá»­i lÃªn!");
      const offer = JSON.parse(offerSnap.val());
      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      db.ref("webrtc/answer").set(JSON.stringify(answer));
      pc.onicecandidate = e => {
        if (e.candidate) db.ref("webrtc/receiver_candidate").push(JSON.stringify(e.candidate));
      };
    }

    async function startTwoWayCall() {
      await setupLocalStream(true); // cÃ³ mic
      pc.ontrack = (event) => remoteVideo.srcObject = event.streams[0];
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      db.ref("webrtc/offer").set(JSON.stringify(offer));
      pc.onicecandidate = e => {
        if (e.candidate) db.ref("webrtc/sender_candidate").push(JSON.stringify(e.candidate));
      };
    }

    // Nháº­n answer náº¿u lÃ  sender
    db.ref("webrtc/answer").on("value", async (snap) => {
      if (!pc.currentRemoteDescription && snap.val()) {
        const answer = JSON.parse(snap.val());
        await pc.setRemoteDescription(new RTCSessionDescription(answer));
      }
    });

    // Nháº­n ICE tá»« bÃªn kia
    db.ref("webrtc/sender_candidate").on("child_added", (snap) => {
      const cand = new RTCIceCandidate(JSON.parse(snap.val()));
      pc.addIceCandidate(cand);
    });

    db.ref("webrtc/receiver_candidate").on("child_added", (snap) => {
      const cand = new RTCIceCandidate(JSON.parse(snap.val()));
      pc.addIceCandidate(cand);
    });
  </script>
</body>
</html>