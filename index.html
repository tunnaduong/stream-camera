<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Call 2 People</title>
  <style>
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    video {
      width: 100%;
      height: 50%;
      object-fit: cover;
    }

    #localVideo {
      background: black;
    }

    #remoteVideo {
      background: gray;
    }
  </style>
</head>
<body>
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script>
// Cấu hình Firebase
const firebaseConfig = {
        apiKey: "AIzaSyCXq2XuAoR_Z0Cx4ZGzqoYQ56qbBZN4wxM",
        authDomain: "stream-camera-27465.firebaseapp.com",
        databaseURL: "https://stream-camera-27465-default-rtdb.firebaseio.com",
        projectId: "stream-camera-27465",
        storageBucket: "stream-camera-27465.firebasestorage.app",
        messagingSenderId: "317939678008",
        appId: "1:317939678008:web:1b628b1fc43822130bdfcd",
        measurementId: "G-ENKM03MX2Q",
      };

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ID cuộc gọi (dùng chung)
const callId = "test-call";

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");

let pc = new RTCPeerConnection({
  iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
});

let isCaller = false;

// Lấy media
navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
  localVideo.srcObject = stream;
  stream.getTracks().forEach(track => pc.addTrack(track, stream));
}).catch(e => {
  console.error("Lỗi media: ", e);
});

// Gửi ICE Candidate
pc.onicecandidate = event => {
  if (event.candidate) {
    const icePath = isCaller ? 'callerIce' : 'calleeIce';
    db.ref(`${callId}/${icePath}`).push(JSON.stringify(event.candidate));
  }
};

// Nhận remote stream
pc.ontrack = event => {
  remoteVideo.srcObject = event.streams[0];
};

// Bắt đầu gọi hoặc chờ nhận cuộc gọi
db.ref(`${callId}/offer`).once('value').then(snapshot => {
  if (snapshot.exists()) {
    // Vai trò: Người nhận
    isCaller = false;
    const offer = JSON.parse(snapshot.val());
    pc.setRemoteDescription(new RTCSessionDescription(offer)).then(() => {
      return pc.createAnswer();
    }).then(answer => {
      return pc.setLocalDescription(answer);
    }).then(() => {
      db.ref(`${callId}/answer`).set(JSON.stringify(pc.localDescription));
    });
  } else {
    // Vai trò: Người gọi
    isCaller = true;
    pc.createOffer().then(offer => {
      return pc.setLocalDescription(offer);
    }).then(() => {
      db.ref(`${callId}/offer`).set(JSON.stringify(pc.localDescription));
    });
  }
});

// Nghe answer nếu là caller
db.ref(`${callId}/answer`).on('value', snapshot => {
  if (snapshot.exists() && isCaller) {
    const answer = JSON.parse(snapshot.val());
    pc.setRemoteDescription(new RTCSessionDescription(answer));
  }
});

// Nhận ICE Candidate từ phía bên kia
const remoteIcePath = isCaller ? 'calleeIce' : 'callerIce';
db.ref(`${callId}/${remoteIcePath}`).on('child_added', snapshot => {
  const candidate = new RTCIceCandidate(JSON.parse(snapshot.val()));
  pc.addIceCandidate(candidate).catch(e => console.error("Lỗi ICE: ", e));
});
  </script>
</body>
</html>