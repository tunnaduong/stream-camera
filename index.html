<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Stream Camera t·ª´ iPhone</title>
    <style>
      body {
        margin: 0;
        background-color: #000;
        color: #fff;
        font-family: Arial, sans-serif;
        text-align: center;
      }
      #videos {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 20px;
      }
      video {
        width: 108%;
        max-width: 70%;
        /* margin: 10px; */
        border: 2px solid #fff;
        border-radius: 10px;
        background: #000;
      }
      #controls {
        margin-top: 20px;
      }
      button {
        font-size: 1.2em;
        padding: 15px 30px;
        margin: 10px;
        border: none;
        border-radius: 5px;
        background-color: #1e90ff;
        color: #fff;
        cursor: pointer;
      }
      button:hover {
        background-color: #0f78d1;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <button onclick="startSender()">üì± G·ª≠i t·ª´ iPhone</button>
      <button onclick="startReceiver()">üñ• Nh·∫≠n tr√™n M√°y T√≠nh</button>
      <button onclick="resetRoom()">üßπ Xo√° to√†n b·ªô d·ªØ li·ªáu</button>
    </div>

    <video id="video" autoplay playsinline muted></video>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
      // üîê D√°n config Firebase c·ªßa b·∫°n t·∫°i ƒë√¢y (t·∫°o project free)
      const firebaseConfig = {
        apiKey: "AIzaSyCXq2XuAoR_Z0Cx4ZGzqoYQ56qbBZN4wxM",
        authDomain: "stream-camera-27465.firebaseapp.com",
        databaseURL: "https://stream-camera-27465-default-rtdb.firebaseio.com",
        projectId: "stream-camera-27465",
        storageBucket: "stream-camera-27465.firebasestorage.app",
        messagingSenderId: "317939678008",
        appId: "1:317939678008:web:1b628b1fc43822130bdfcd",
        measurementId: "G-ENKM03MX2Q",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const roomId = "webrtc";
      const roomRef = db.ref(roomId);

      let pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      });

      let localStream = null;
      const video = document.getElementById("video");

      async function startSender() {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: false,
        });
        video.srcObject = localStream;

        localStream
          .getTracks()
          .forEach((track) => pc.addTrack(track, localStream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        db.ref("webrtc/offer").set(JSON.stringify(offer));

        pc.onicecandidate = (e) => {
          if (e.candidate) {
            db.ref("webrtc/sender_candidate").push(JSON.stringify(e.candidate));
          }
        };
      }

      async function startReceiver() {
        pc.ontrack = (event) => {
          video.srcObject = event.streams[0];
        };

        const offerData = await db.ref("webrtc/offer").once("value");
        const offer = JSON.parse(offerData.val());
        await pc.setRemoteDescription(new RTCSessionDescription(offer));

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        db.ref("webrtc/answer").set(JSON.stringify(answer));

        pc.onicecandidate = (e) => {
          if (e.candidate) {
            db.ref("webrtc/receiver_candidate").push(
              JSON.stringify(e.candidate)
            );
          }
        };

        // L·∫Øng nghe sender ICE
        db.ref("webrtc/sender_candidate").on("child_added", (snap) => {
          const candidate = new RTCIceCandidate(JSON.parse(snap.val()));
          pc.addIceCandidate(candidate);
        });
      }

      // L·∫Øng nghe receiver ICE n·∫øu l√† sender
      db.ref("webrtc/answer").on("value", async (snap) => {
        if (!pc.currentRemoteDescription && snap.val()) {
          const answer = JSON.parse(snap.val());
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
        }
      });

      db.ref("webrtc/receiver_candidate").on("child_added", (snap) => {
        const candidate = new RTCIceCandidate(JSON.parse(snap.val()));
        pc.addIceCandidate(candidate);
      });

      async function resetRoom() {
        const confirmReset = confirm(
          "‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën xo√° to√†n b·ªô d·ªØ li·ªáu ph√≤ng?"
        );
        if (!confirmReset) return;

        await roomRef.set(null);
        console.log("üßπ ƒê√£ xo√° to√†n b·ªô d·ªØ li·ªáu trong room:", roomId);
        alert("ƒê√£ xo√° s·∫°ch d·ªØ li·ªáu Firebase üéâ");
      }
    </script>
  </body>
</html>
