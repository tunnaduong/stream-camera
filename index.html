<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>G·ªçi Video Hai Chi·ªÅu</title>
  <style>
    body {
      margin: 0;
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    #videos {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    video {
      width: 45%;
      max-width: 600px;
      margin: 10px;
      border: 2px solid #fff;
      border-radius: 10px;
      background: #000;
    }
    #controls {
      margin-top: 20px;
    }
    button {
      font-size: 1.2em;
      padding: 15px 30px;
      margin: 10px;
      border: none;
      border-radius: 5px;
      background-color: #1e90ff;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      background-color: #0f78d1;
    }
  </style>
</head>
<body>
  <h1>G·ªçi Video Hai Chi·ªÅu</h1>
  <div id="videos">
    <video id="localVideo" autoplay playsinline muted></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>
  <div id="controls">
    <button onclick="startAsCaller()">üì± G·ª≠i t·ª´ iPhone</button>
    <button onclick="startAsCallee()">üñ• Nh·∫≠n tr√™n m√°y t√≠nh</button>
    <button onclick="startTwoWay()">üìû G·ªçi 2 chi·ªÅu</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    // Firebase config c·ªßa b·∫°n
    const firebaseConfig = {
      apiKey: "AIzaSyCXq2XuAoR_Z0Cx4ZGzqoYQ56qbBZN4wxM",
      authDomain: "stream-camera-27465.firebaseapp.com",
      databaseURL: "https://stream-camera-27465-default-rtdb.firebaseio.com",
      projectId: "stream-camera-27465",
      storageBucket: "stream-camera-27465.firebasestorage.app",
      messagingSenderId: "317939678008",
      appId: "1:317939678008:web:1b628b1fc43822130bdfcd",
      measurementId: "G-ENKM03MX2Q"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();
    const roomId = "room123"; // c√≥ th·ªÉ random n·∫øu c·∫ßn
    const roomRef = db.ref("rooms/" + roomId);

    let pc;
    let localStream;
    let remoteStream = new MediaStream();

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    async function initLocalMedia(withAudio = true) {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: withAudio });
      localVideo.srcObject = localStream;
    }

    function createPeerConnection() {
      pc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
      });

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.ontrack = event => {
        event.streams[0].getTracks().forEach(track => {
          remoteStream.addTrack(track);
        });
        remoteVideo.srcObject = remoteStream;
      };

      pc.onicecandidate = event => {
        if (event.candidate) {
          const candidateRef = roomRef.child('candidates/' + (isCaller ? 'offer' : 'answer'));
          candidateRef.push(JSON.stringify(event.candidate));
        }
      };
    }

    let isCaller = false;

    async function startAsCaller() {
      isCaller = true;
      await initLocalMedia(false);
      createPeerConnection();

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await roomRef.child("offer").set(JSON.stringify(offer));

      // L·∫Øng nghe answer
      roomRef.child("answer").on("value", async snapshot => {
        const answer = snapshot.val();
        if (answer && !pc.currentRemoteDescription) {
          await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)));
        }
      });

      // ICE t·ª´ ng∆∞·ªùi nh·∫≠n
      roomRef.child("candidates/answer").on("child_added", snapshot => {
        const candidate = new RTCIceCandidate(JSON.parse(snapshot.val()));
        pc.addIceCandidate(candidate);
      });
    }

    async function startAsCallee() {
      isCaller = false;
      await initLocalMedia(false);
      createPeerConnection();

      // L·∫•y offer
      const offerSnapshot = await roomRef.child("offer").once("value");
      const offer = JSON.parse(offerSnapshot.val());
      await pc.setRemoteDescription(new RTCSessionDescription(offer));

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await roomRef.child("answer").set(JSON.stringify(answer));

      // ICE t·ª´ ng∆∞·ªùi g·ª≠i
      roomRef.child("candidates/offer").on("child_added", snapshot => {
        const candidate = new RTCIceCandidate(JSON.parse(snapshot.val()));
        pc.addIceCandidate(candidate);
      });

      // G·ª≠i ICE c·ªßa m√¨nh
      roomRef.child("candidates/answer").onDisconnect().remove();
    }

    async function startTwoWay() {
      isCaller = true;
      await initLocalMedia(true);
      createPeerConnection();

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await roomRef.child("offer").set(JSON.stringify(offer));

      roomRef.child("answer").on("value", async snapshot => {
        const answer = snapshot.val();
        if (answer && !pc.currentRemoteDescription) {
          await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)));
        }
      });

      roomRef.child("candidates/answer").on("child_added", snapshot => {
        const candidate = new RTCIceCandidate(JSON.parse(snapshot.val()));
        pc.addIceCandidate(candidate);
      });
    }

    // T·ª± ƒë·ªông g·ªçi khi m·ªü trang
    window.onload = () => {
      startTwoWay();
    };
  </script>
</body>
</html>